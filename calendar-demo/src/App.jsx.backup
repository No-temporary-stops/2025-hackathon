import React, { useState } from "react";
import { Calendar, momentLocalizer, Views } from "react-big-calendar";
import moment from "moment";
import "moment/locale/zh-tw"; // ä¸­æ–‡æœ¬åœ°åŒ–
import "react-big-calendar/lib/css/react-big-calendar.css";

// è¨­å®šä¸­æ–‡æ™‚é–“æ ¼å¼
moment.locale('zh-tw');
const localizer = momentLocalizer(moment);

// ä¸­æ–‡åŒ–æ—¥æ›†é¡¯ç¤ºæ–‡å­—
const messages = {
  allDay: 'å…¨å¤©',
  previous: 'ä¸Šä¸€å€‹',
  next: 'ä¸‹ä¸€å€‹',
  today: 'ä»Šå¤©',
  month: 'æœˆ',
  week: 'é€±',
  day: 'æ—¥',
  agenda: 'è­°ç¨‹',
  date: 'æ—¥æœŸ',
  time: 'æ™‚é–“',
  event: 'äº‹ä»¶',
  noEventsInRange: 'æ­¤æ™‚é–“ç¯„åœå…§æ²’æœ‰äº‹ä»¶',
  showMore: total => `é‚„æœ‰ ${total} å€‹äº‹ä»¶`,
};

const MyCalendar = () => {
  // å„²å­˜æ‰€æœ‰äº‹ä»¶
  const [events, setEvents] = useState([
    {
      title: "ç¹³äº¤æ•¸å­¸ä½œæ¥­",
      start: new Date(2025, 8, 20, 10, 0),
      end: new Date(2025, 8, 20, 12, 0),
    },
    {
      title: "è¡Œæ”¿ç¹³è²»æˆªæ­¢",
      start: new Date(2025, 8, 22, 23, 59),
      end: new Date(2025, 8, 22, 23, 59),
    },
  ]);

  // è¢«é¸åˆ°çš„äº‹ä»¶
  const [selectedEvent, setSelectedEvent] = useState(null);
  
  // æ—¥æ›†è¦–åœ–è¨­å®š
  const [currentDate, setCurrentDate] = useState(new Date());
  const [currentView, setCurrentView] = useState(Views.MONTH);

  // æ–°äº‹ä»¶è¼¸å…¥ç”¨
  const getDefaultTimes = () => {
    const now = new Date();
    const start = new Date(now);
    start.setMinutes(0, 0, 0); // è¨­å®šç‚ºæ•´é»
    const end = new Date(start);
    end.setHours(start.getHours() + 1); // é è¨­æŒçºŒ1å°æ™‚
    
    return {
      start: formatDateTimeLocal(start),
      end: formatDateTimeLocal(end)
    };
  };

  const [newEvent, setNewEvent] = useState({
    title: "",
    start: "",
    end: "",
  });
  
  // è¡¨å–®é¡¯ç¤ºç‹€æ…‹
  const [showForm, setShowForm] = useState(false);

  // æ—¥æ›†å°èˆªè™•ç†å‡½æ•¸
  const handleNavigate = (newDate) => {
    setCurrentDate(newDate);
  };

  const handleViewChange = (view) => {
    setCurrentView(view);
  };

  // å›åˆ°ä»Šå¤©
  const handleToday = () => {
    setCurrentDate(new Date());
  };

  // åŠ å…¥æ–°äº‹ä»¶
  const handleAddEvent = (e) => {
    e.preventDefault();

    if (!newEvent.title || !newEvent.start || !newEvent.end) {
      alert("è«‹å®Œæ•´è¼¸å…¥æ¨™é¡Œèˆ‡æ™‚é–“ï¼");
      return;
    }

    const startDate = new Date(newEvent.start);
    const endDate = new Date(newEvent.end);
    
    if (endDate <= startDate) {
      alert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼");
      return;
    }

    setEvents([
      ...events,
      {
        title: newEvent.title,
        start: startDate,
        end: endDate,
      },
    ]);

    setNewEvent({ title: "", start: "", end: "" });
    setShowForm(false);
  };

  // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç”¨æ–¼è¼¸å…¥æ¡†
  const formatDateTimeLocal = (date) => {
    if (!date) {
      // å¦‚æœæ²’æœ‰æ—¥æœŸï¼Œè¿”å›ç•¶å‰æ™‚é–“ä½œç‚ºé è¨­å€¼
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      const localTime = new Date(now.getTime() - offset);
      return localTime.toISOString().slice(0, 16);
    }
    if (typeof date === 'string' && date.includes('T')) {
      // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›
      return date.slice(0, 16);
    }
    const d = new Date(date);
    const offset = d.getTimezoneOffset() * 60000;
    const localTime = new Date(d.getTime() - offset);
    return localTime.toISOString().slice(0, 16);
  };

  return (
    <div style={{ 
      minHeight: "100vh",
      backgroundColor: "#f5f7fa",
      fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif" 
    }}>
      <div style={{ 
        maxWidth: "1200px",
        margin: "0 auto",
        padding: "20px" 
      }}>
        {/* æ¨™é¡Œå€ */}
        <div style={{ 
          display: "flex", 
          justifyContent: "space-between", 
          alignItems: "center", 
          marginBottom: "30px",
          padding: "20px",
          backgroundColor: "white",
          borderRadius: "12px",
          boxShadow: "0 2px 8px rgba(0,0,0,0.1)"
        }}>
          <h1 style={{ 
            margin: 0, 
            color: "#2d3748",
            fontSize: "28px",
            fontWeight: "600"
          }}>
            ğŸ“… æ ¡åœ’æ—¥æ›†
          </h1>
          <button 
            onClick={() => {
              if (!showForm) {
                // æ‰“é–‹è¡¨å–®æ™‚è¨­å®šé è¨­æ™‚é–“
                const defaultTimes = getDefaultTimes();
                setNewEvent({
                  title: "",
                  start: defaultTimes.start,
                  end: defaultTimes.end,
                });
              }
              setShowForm(!showForm);
            }}
            style={{
              padding: "12px 24px",
              backgroundColor: showForm ? "#e53e3e" : "#4299e1",
              color: "white",
              border: "none",
              borderRadius: "8px",
              cursor: "pointer",
              fontSize: "14px",
              fontWeight: "500",
              transition: "all 0.2s ease",
              boxShadow: "0 2px 4px rgba(0,0,0,0.1)"
            }}
            onMouseOver={(e) => {
              e.target.style.transform = "translateY(-1px)";
              e.target.style.boxShadow = "0 4px 8px rgba(0,0,0,0.15)";
            }}
            onMouseOut={(e) => {
              e.target.style.transform = "translateY(0)";
              e.target.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
            }}
          >
            {showForm ? "âœ• å–æ¶ˆ" : "â• æ–°å¢äº‹ä»¶"}
          </button>
        </div>

      {/* è‡ªå®šç¾©å·¥å…·åˆ— */}
      <div style={{ 
        display: "flex", 
        gap: "10px", 
        marginBottom: "20px", 
        alignItems: "center",
        flexWrap: "wrap"
      }}>
        <button 
          onClick={handleToday}
          style={{
            padding: "8px 15px",
            backgroundColor: "#28a745",
            color: "white",
            border: "none",
            borderRadius: "3px",
            cursor: "pointer"
          }}
        >
          ä»Šå¤©
        </button>
        
        <div style={{ display: "flex", gap: "5px" }}>
          <button 
            onClick={() => handleNavigate(moment(currentDate).subtract(1, currentView).toDate())}
            style={{
              padding: "8px 12px",
              backgroundColor: "#6c757d",
              color: "white",
              border: "none",
              borderRadius: "3px",
              cursor: "pointer"
            }}
          >
            â†
          </button>
          <button 
            onClick={() => handleNavigate(moment(currentDate).add(1, currentView).toDate())}
            style={{
              padding: "8px 12px",
              backgroundColor: "#6c757d",
              color: "white",
              border: "none",
              borderRadius: "3px",
              cursor: "pointer"
            }}
          >
            â†’
          </button>
        </div>
        
        <span style={{ 
          fontSize: "18px", 
          fontWeight: "bold",
          minWidth: "200px",
          textAlign: "center"
        }}>
          {moment(currentDate).format('YYYYå¹´MMæœˆ')}
        </span>
        
        <div style={{ display: "flex", gap: "5px", marginLeft: "auto" }}>
          {[Views.MONTH, Views.WEEK, Views.DAY, Views.AGENDA].map((view) => (
            <button
              key={view}
              onClick={() => handleViewChange(view)}
              style={{
                padding: "8px 12px",
                backgroundColor: currentView === view ? "#007bff" : "#e9ecef",
                color: currentView === view ? "white" : "#495057",
                border: "1px solid #dee2e6",
                borderRadius: "3px",
                cursor: "pointer"
              }}
            >
              {view === Views.MONTH && 'æœˆ'}
              {view === Views.WEEK && 'é€±'}
              {view === Views.DAY && 'æ—¥'}
              {view === Views.AGENDA && 'è­°ç¨‹'}
            </button>
          ))}
        </div>
      </div>

      {/* æ—¥æ›† */}
      <Calendar
        localizer={localizer}
        events={events}
        startAccessor="start"
        endAccessor="end"
        style={{ height: 500 }}
        messages={messages}
        date={currentDate}
        view={currentView}
        onNavigate={handleNavigate}
        onView={handleViewChange}
        onSelectEvent={(event) => setSelectedEvent(event)} // é»æ“Šäº‹ä»¶ â†’ é¡¯ç¤ºè©³æƒ…
        toolbar={false} // éš±è—å…§å»ºå·¥å…·åˆ—
        popup
        step={60}
        showMultiDayTimes
        defaultDate={new Date()}
      />

      {/* é¡¯ç¤ºé»æ“Šçš„äº‹ä»¶ */}
      {selectedEvent && (
        <div
          style={{
            marginTop: "20px",
            padding: "20px",
            border: "2px solid #007bff",
            borderRadius: "8px",
            backgroundColor: "#f8f9fa",
            boxShadow: "0 2px 4px rgba(0,0,0,0.1)"
          }}
        >
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "15px" }}>
            <h3 style={{ margin: 0, color: "#007bff" }}>ğŸ“Œ äº‹ä»¶è©³æƒ…</h3>
            <button 
              onClick={() => setSelectedEvent(null)}
              style={{
                padding: "5px 10px",
                backgroundColor: "#dc3545",
                color: "white",
                border: "none",
                borderRadius: "3px",
                cursor: "pointer"
              }}
            >
              âœ•
            </button>
          </div>
          
          <div style={{ fontSize: "16px", lineHeight: "1.6" }}>
            <div style={{ marginBottom: "10px" }}>
              <span style={{ fontWeight: "bold", color: "#495057" }}>æ¨™é¡Œï¼š</span>
              <span style={{ marginLeft: "10px" }}>{selectedEvent.title}</span>
            </div>
            <div style={{ marginBottom: "10px" }}>
              <span style={{ fontWeight: "bold", color: "#495057" }}>é–‹å§‹æ™‚é–“ï¼š</span>
              <span style={{ marginLeft: "10px" }}>
                {moment(selectedEvent.start).format('YYYYå¹´MMæœˆDDæ—¥ HH:mm')}
              </span>
            </div>
            <div style={{ marginBottom: "10px" }}>
              <span style={{ fontWeight: "bold", color: "#495057" }}>çµæŸæ™‚é–“ï¼š</span>
              <span style={{ marginLeft: "10px" }}>
                {moment(selectedEvent.end).format('YYYYå¹´MMæœˆDDæ—¥ HH:mm')}
              </span>
            </div>
            <div>
              <span style={{ fontWeight: "bold", color: "#495057" }}>æ™‚é•·ï¼š</span>
              <span style={{ marginLeft: "10px" }}>
                {moment.duration(moment(selectedEvent.end).diff(moment(selectedEvent.start))).humanize()}
              </span>
            </div>
          </div>
        </div>
      )}

      {/* æ–°å¢äº‹ä»¶è¡¨å–® */}
      {showForm && (
        <div
          style={{
            marginTop: "20px",
            padding: "20px",
            border: "1px solid #ddd",
            borderRadius: "8px",
            backgroundColor: "#f8f9fa"
          }}
        >
          <h3>â• æ–°å¢äº‹ä»¶</h3>
          <form onSubmit={handleAddEvent}>
            <div style={{ marginBottom: "15px" }}>
              <label style={{ display: "block", marginBottom: "5px", fontWeight: "bold" }}>
                äº‹ä»¶æ¨™é¡Œ *
              </label>
              <input
                type="text"
                placeholder="ä¾‹ï¼šç¹³äº¤æ•¸å­¸ä½œæ¥­"
                value={newEvent.title}
                onChange={(e) => setNewEvent({ ...newEvent, title: e.target.value })}
                style={{ 
                  width: "100%",
                  padding: "8px",
                  border: "1px solid #ced4da",
                  borderRadius: "4px",
                  fontSize: "14px"
                }}
                required
              />
            </div>
            
            <div style={{ display: "flex", gap: "15px", marginBottom: "15px" }}>
              <div style={{ flex: 1 }}>
                <label style={{ display: "block", marginBottom: "5px", fontWeight: "bold" }}>
                  é–‹å§‹æ™‚é–“ *
                </label>
                <input
                  type="datetime-local"
                  value={formatDateTimeLocal(newEvent.start)}
                  onChange={(e) => setNewEvent({ ...newEvent, start: e.target.value })}
                  style={{ 
                    width: "100%",
                    padding: "8px",
                    border: "1px solid #ced4da",
                    borderRadius: "4px",
                    fontSize: "14px"
                  }}
                  required
                />
              </div>
              
              <div style={{ flex: 1 }}>
                <label style={{ display: "block", marginBottom: "5px", fontWeight: "bold" }}>
                  çµæŸæ™‚é–“ *
                </label>
                <input
                  type="datetime-local"
                  value={formatDateTimeLocal(newEvent.end)}
                  onChange={(e) => setNewEvent({ ...newEvent, end: e.target.value })}
                  style={{ 
                    width: "100%",
                    padding: "8px",
                    border: "1px solid #ced4da",
                    borderRadius: "4px",
                    fontSize: "14px"
                  }}
                  required
                />
              </div>
            </div>
            
            <div style={{ display: "flex", gap: "10px" }}>
              <button 
                type="submit"
                style={{
                  padding: "10px 20px",
                  backgroundColor: "#28a745",
                  color: "white",
                  border: "none",
                  borderRadius: "5px",
                  cursor: "pointer",
                  fontSize: "14px"
                }}
              >
                ç¢ºèªæ–°å¢
              </button>
              <button 
                type="button"
                onClick={() => {
                  setShowForm(false);
                  setNewEvent({ title: "", start: "", end: "" });
                }}
                style={{
                  padding: "10px 20px",
                  backgroundColor: "#6c757d",
                  color: "white",
                  border: "none",
                  borderRadius: "5px",
                  cursor: "pointer",
                  fontSize: "14px"
                }}
              >
                å–æ¶ˆ
              </button>
            </div>
          </form>
        </div>
      )}
    </div>
  );
};

export default MyCalendar;
